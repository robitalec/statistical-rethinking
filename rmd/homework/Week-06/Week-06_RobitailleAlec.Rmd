---
author: "Alec L. Robitaille"
output: github_document
editor_options: 
  chunk_output_type: console
---

# Homework: Week 6
2021-09-06 [updated: `r Sys.Date()`]

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rethinking)
options(digits = 2, scipen = 999)
```

## Question 1

> The data in `data(NWOGrants)` are outcomes for scientific funding applications
for the Netherlands Organization for Scientific Research (NWO) from 2010–2012
(see van der Lee and Ellemers doi:10.1073/pnas.1510159112). These data have a
very similar structure to the UCBAdmit data discussed in Chapter 11. I want you
to consider a similar question: What are the total and indirect causal effects
of gender on grant awards? Consider a mediation path (a pipe) through dis-
cipline. Draw the corresponding DAG and then use one or more binomial GLMs to
answer the question.


### Data

```{r}
data(NWOGrants)
setDT(NWOGrants)

precis(NWOGrants)
summary(NWOGrants)
```

* Discipline: factor with 9 levels
* Gender: factor with 2 levels in this data (...)
* Applications: count
* Awards: count


```{r}
NWOGrants[, index_gender := .GRP, gender]
NWOGrants[, index_discipline := .GRP, discipline]

q1_data <- c(
	as.list(NWOGrants[, .(awards, applications, index_gender, index_discipline)]),
	N = NWOGrants[, .N],
	N_gender = NWOGrants[, uniqueN(index_gender)],
	N_discipline = NWOGrants[, uniqueN(index_discipline)]
)
```

### DAG
```{r}
dag <- dagify(
	awards ~ index_gender + index_discipline,
	index_discipline ~ index_gender,
	exposure = 'index_gender',
	outcome = 'awards'
)

dag_plot(dag)
```

### Priors
```{r}
register_knitr_engine(override = FALSE)
```

```{cmdstan, output.var = 'q1_prior'}
data {
  int<lower=0> N;
  int<lower=0> N_gender;
  int<lower=0> N_discipline;
}
parameters{
  real alpha;
  vector[N_gender] beta_gender;
  vector[N_discipline] beta_discipline;
  real<lower=0> sigma;
  real<lower=0,upper=1> theta;
}
model{
  alpha ~ normal(0, 0.2);
  beta_gender ~ normal(0, 0.25);
  beta_discipline ~ normal(0, 0.25);
  sigma ~ exponential(1);
  theta ~ beta(1, 1);
}
```

```{r}
# q1_stan <- 'q1_prior.stan'
# writeLines(readLines(q1_stan))
# q1_prior <- cmdstan_model(q1_stan)

q1_prior_sample <- q1_prior$sample(data = q1_data[c('N',
																										'N_gender',
																										'N_discipline')])

q1_prior_draws <- cmd_draws(q1_prior_sample)

mcmc_areas(q1_prior_draws, regex_pars = 'theta')
mcmc_areas(q1_prior_draws, regex_pars = 'sigma')
mcmc_areas(q1_prior_draws, regex_pars = 'beta_gender')
mcmc_areas(q1_prior_draws, regex_pars = 'beta_discipline')
```

### Model
```{cmdstan, output.var = 'q1_model'}
data {
  int<lower=0> N;
  int<lower=0> N_gender;
  int awards[N];
  int applications [N];
  int index_gender[N];
}
parameters{
  vector[N_gender] alpha;
}
model{
  vector[N] p;
  alpha ~ normal(-1, 1);

  p = inv_logit(alpha[index_gender]);
  awards ~ binomial(applications, p);
}
```

```{r}
# q1_stan <- 'q1.stan'
# writeLines(readLines(q1_stan))
# q1_model <- cmdstan_model(q1_stan)

q1_sample <- q1_model$sample(data = q1_data)

q1_draws <- cmd_draws(q1_sample)

mcmc_areas(q1_draws, regex_pars = 'alpha')

q1_draws$dif_alpha <- (inv.logit(q1_draws$`alpha[1]`) -
	inv.logit(q1_draws$`alpha[2]`)) * 100
mcmc_areas(q1_draws, regex_pars = 'dif_alpha')
```

With discipline

```{cmdstan, output.var = 'q1_model_discipline'}
data {
  int<lower=0> N;
  int<lower=0> N_gender;
  int<lower=0> N_discipline;
  int awards[N];
  int applications [N];
  int index_gender[N];
  int index_discipline[N];
}
parameters{
  vector[N_gender] alpha;
  vector[N_discipline] beta;
}
model{
  vector[N] p;
  alpha ~ normal(-1, 1);
  beta ~ normal(0, 0.25);

  p = inv_logit(alpha[index_gender] + beta[index_discipline]);
  awards ~ binomial(applications, p);
}
```

```{r}
# q1_stan <- 'q1_discipline.stan'
# writeLines(readLines(q1_stan))
# q1_model_discipline <- cmdstan_model(q1_stan)

q1_sample <- q1_model_discipline$sample(data = q1_data)

q1_draws <- cmd_draws(q1_sample)

mcmc_areas(q1_draws, regex_pars = 'alpha')
mcmc_areas(q1_draws, regex_pars = 'beta')

# Need to account for base rates to look at absolute rate
# q1_draws$dif_alpha <- (inv.logit(q1_draws$`alpha[1]`) -
# 	inv.logit(q1_draws$`alpha[2]`)) * 100
# mcmc_areas(q1_draws, regex_pars = 'dif_alpha')

# We can look at relative rates though
q1_draws$dif_alpha_rel <- q1_draws$`alpha[1]` - q1_draws$`alpha[2]`
mcmc_areas(q1_draws, regex_pars = 'dif_alpha_rel')
```

> What is your causal interpretation? If NWO’s goal is to equalize rates of
funding between the genders, what type of intervention would be most effective?

Investigate departmental levels, since once this is included the relative differences are small. 
