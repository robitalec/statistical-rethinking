---
author: "Alec L. Robitaille"
output: github_document
editor_options: 
  chunk_output_type: console
---

# Homework: Week 6
2021-09-06 [updated: `r Sys.Date()`]

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rethinking)
options(digits = 2, scipen = 999)
```

### Setup

```{r}
# Packages
library(ggdag)
library(dagitty)
library(data.table)
library(ggplot2)
library(rethinking)
library(cmdstanr)
library(posterior)
library(bayesplot)

# Functions
dag_plot <- function(dag) {
	stat <- node_status(dag, FALSE)
	stat$data$status[is.na(stat$data$status)] <- 'intermediate'
	ggplot(stat, aes(x = x, y = y, xend = xend, yend = yend)) +
	  geom_dag_point(aes(color = status), alpha = 0.5, size = 15) +
	  geom_dag_edges() +
		labs(color = '') + 
	  geom_dag_text(color = 'black') +
		scale_color_manual(values = list('exposure' = '#35608DFF',
																		 'outcome' = '#22A884FF',
																		 'intermediate' = 'grey50')) + 
	  theme_void()
}

cmd_draws <- function(model) {
	as_draws_df(model$draws())
}
```

## Question 1

> The data in `data(NWOGrants)` are outcomes for scientific funding applications
for the Netherlands Organization for Scientific Research (NWO) from 2010–2012
(see van der Lee and Ellemers doi:10.1073/pnas.1510159112). These data have a
very similar structure to the UCBAdmit data discussed in Chapter 11. I want you
to consider a similar question: What are the total and indirect causal effects
of gender on grant awards? Consider a mediation path (a pipe) through dis-
cipline. Draw the corresponding DAG and then use one or more binomial GLMs to
answer the question.


### Data

```{r}
data(NWOGrants)
setDT(NWOGrants)

precis(NWOGrants)
summary(NWOGrants)
```

* Discipline: factor with 9 levels
* Gender: factor with 2 levels in this data (...)
* Applications: count
* Awards: count


```{r}
NWOGrants[, index_gender := .GRP, gender]
NWOGrants[, index_discipline := .GRP, discipline]

q1_data <- c(
	as.list(NWOGrants[, .(awards, applications, index_gender, index_discipline)]),
	N = NWOGrants[, .N],
	N_gender = NWOGrants[, uniqueN(index_gender)],
	N_discipline = NWOGrants[, uniqueN(index_discipline)]
)
```

### DAG
```{r}
dag <- dagify(
	awards ~ index_gender + index_discipline,
	index_discipline ~ index_gender,
	exposure = 'index_gender',
	outcome = 'awards'
)

dag_plot(dag)
```

### Priors
```{r}
register_knitr_engine(override = FALSE)
```

```{cmdstan, output.var = 'q1_prior'}
data {
  int<lower=0> N;
  int<lower=0> N_gender;
  int<lower=0> N_discipline;
}
parameters{
  real alpha;
  vector[N_gender] beta_gender;
  vector[N_discipline] beta_discipline;
  real<lower=0> sigma;
  real<lower=0,upper=1> theta;
}
model{
  alpha ~ normal(0, 0.2);
  beta_gender ~ normal(0, 0.25);
  beta_discipline ~ normal(0, 0.25);
  sigma ~ exponential(1);
  theta ~ beta(1, 1);
}
```

```{r}
# q1_stan <- 'q1_prior.stan'
# writeLines(readLines(q1_stan))
# q1_prior <- cmdstan_model(q1_stan)

q1_prior_sample <- q1_prior$sample(data = q1_data[c('N',
																										'N_gender',
																										'N_discipline')])

q1_prior_draws <- cmd_draws(q1_prior_sample)

mcmc_areas(q1_prior_draws, regex_pars = 'theta')
mcmc_areas(q1_prior_draws, regex_pars = 'sigma')
mcmc_areas(q1_prior_draws, regex_pars = 'beta_gender')
mcmc_areas(q1_prior_draws, regex_pars = 'beta_discipline')
```

### Model
```{cmdstan, output.var = 'q1_model'}
data {
  int<lower=0> N;
  int<lower=0> N_gender;
  int<lower=0> N_discipline;
  int awards;
  int index_gender;
  int index_discipline;
}
parameters{
  real alpha;
  vector[N_gender] beta_gender;
  vector[N_discipline] beta_discipline;
  real<lower=0> sigma;
  real<lower=0,upper=1> theta;
}
model{
  alpha ~ normal(0, 0.2);
  beta_gender ~ normal(0, 0.25);
  beta_discipline ~ normal(0, 0.25);
  sigma ~ exponential(1);
  theta ~ beta(1, 1);
  awards ~ binomial(N, theta);
}
```

```{r}
q1_stan <- 'q1.stan'
writeLines(readLines(q1_stan))
q1_model <- cmdstan_model(q1_stan)

q1_sample <- q1_model$sample(data = q1_data)

q1_draws <- cmd_draws(q1_sample)

mcmc_areas(q1_draws, regex_pars = 'theta')
mcmc_areas(q1_draws, regex_pars = 'sigma')
mcmc_areas(q1_draws, regex_pars = 'beta_gender')
mcmc_areas(q1_draws, regex_pars = 'beta_discipline')
```
> What is your causal interpretation? If NWO’s goal is to equalize rates of
funding between the genders, what type of intervention would be most effective?

