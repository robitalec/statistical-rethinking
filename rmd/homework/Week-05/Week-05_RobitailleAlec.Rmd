---
author: "Alec L. Robitaille"
output: github_document
editor_options: 
  chunk_output_type: console
---

# Homework: Week 5
2021-09-03 [updated: `r Sys.Date()`]

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rethinking)
options(digits = 2, scipen = 999)
```

### Setup

```{r}
# Packages
library(ggdag)
library(dagitty)
library(data.table)
library(ggplot2)
library(tidybayes)

# Functions
dag_plot <- function(dag) {
	stat <- node_status(dag, FALSE)
	stat$data$status[is.na(stat$data$status)] <- 'intermediate'
	ggplot(stat, aes(x = x, y = y, xend = xend, yend = yend)) +
	  geom_dag_point(aes(color = status), alpha = 0.5, size = 15) +
	  geom_dag_edges() +
		labs(color = '') + 
	  geom_dag_text(color = 'black') +
		scale_color_manual(values = list('exposure' = '#35608DFF',
																		 'outcome' = '#22A884FF',
																		 'intermediate' = 'grey50')) + 
	  theme_void()
}

cmd_draws <- function(model) {
	as_draws_df(model$draws())
}
```



## Question 1

> Consider the `data(Wines2012)` data table. These data are expert ratings of 20
different French and American wines by 9 different French and American judges.




### Data
> Your goal is to model score, the subjective rating assigned by each judge to
each wine. I recommend standardizing it. In this first problem, consider only
variation among judges and wines. Construct index variables of judge and wine
and then use these index variables to construct a linear regression model.

```{r}
library(rethinking)
library(cmdstanr)
library(data.table)
library(posterior)
library(bayesplot)

data("Wines2012")

DT <- data.table(Wines2012)

DT[, scale_score := scale(score)]
DT[, index_judge := .GRP, judge]
DT[, index_wine := .GRP, wine]

n_index_judge <- DT[, uniqueN(index_judge)]
n_index_wine <- DT[, uniqueN(index_wine)]
n_rows <- DT[, .N]
```

### Prior predictive simulation

```{r}
q1_stan <- 'q1_prior.stan'
writeLines(readLines(q1_stan))

q1_prior <- cmdstan_model(q1_stan)

q1_prior_sample <- q1_prior$sample(
	data = list(N = n_rows,
							N_judges = n_index_judge,
							N_wines = n_index_wine)
)

q1_prior_draws <- cmd_draws(q1_prior_sample)

mcmc_areas(q1_prior_draws, regex_pars = 'judge')
mcmc_areas(q1_prior_draws, regex_pars = 'wine')
```

> Justify your priors. You should end up with 9 judge parameters and 20 wine
parameters. 

Given the parameters are scaled, the prior predictive plots show scaled wine scores mostly between -2 and 2. Since we do not have any prior knowledge about how this relationship (positive/negative slopes), we are satisfied with this 
relatively conservative prior. 

### Model

> Use ulam instead of quap to build this model, and be sure to check
the chains for convergence. If youâ€™d rather build the model directly in Stan or
PyMC3, go ahead. I just want you to use Hamiltonian Monte Carlo instead of
quadratic approximation. 

```{r}
q1_stan <- 'q1.stan'
writeLines(readLines(q1_stan))

q1_model <- cmdstan_model(q1_stan)

q1_sample <- q1_model$sample(
	data = list(N = n_rows,
							N_judges = n_index_judge,
							N_wines = n_index_wine,
							scale_score = DT[, as.numeric(scale_score)],
							index_judge = DT[, as.numeric(index_judge)],
							index_wine = DT[, as.numeric(index_wine)]
							)
)
q1_draws <- cmd_draws(q1_sample)
setDT(q1_draws)
```

> How do you interpret the variation among individual judges and individual
wines? Do you notice any patterns, just by plotting the differences? Which
judges gave the highest/lowest ratings? Which wines were rated worst/ best on
average?


```{r}
# Judges
precis(q1_draws, depth = 2)[3:11,]
melt(q1_draws, measure.vars = patterns('beta_judge'))[, .(mean_score = mean(value)), variable][order(-mean_score)]
mcmc_areas(q1_draws, regex_pars = 'judge')

precis(q1_draws, depth = 2)[12:31,]
melt(q1_draws, measure.vars = patterns('beta_wine'))[, .(mean_score = mean(value)), variable][order(-mean_score)]
mcmc_areas(q1_draws, regex_pars = 'wine')
```

Accounting for judges, most wines are scored with similar distributions. Wine 19
however was particularly poorly scored. Judges, however, have much more variable
scoring with three individuals (judges 1, 2, 5) entirely or almost entirely
scoring lower than other judges. The worst scoring judge was judge 5.




## Question 2

> Now consider three features of the wines and judges: (1) flight: Whether the wine is red or white. (2) wine.amer: Indicator variable for American wines. (3) judge.amer: Indicator variable for American judges. Use indicator or index variables to model the influence of these features on the scores. Omit the individual judge and wine index variables from Problem
1. Do not include interaction effects yet. Again use ulam, justify your priors,
and be sure to check the chains. 

### Data
```{r}
DT[, scale_score := scale(score)]
DT[, index_flight := .GRP, flight]
DT[, index_wine_american := .GRP, wine.amer]
DT[, index_judge_american := .GRP, judge.amer]

n_index_flight <- DT[, uniqueN(flight)]
n_index_wine_american <- DT[, uniqueN(index_wine_american)]
n_index_judge_american <- DT[, uniqueN(index_judge_american)]
n_rows <- DT[, .N]

q2_data <- c(
	as.list(DT[, .(scale_score,
								 index_flight,
								 index_wine_american,
								 index_judge_american)]),
	N_flights = n_index_flight,
	N_wine_american = n_index_wine_american,
	N_judge_american = n_index_judge_american,
	N = n_rows
)
```


### Priors
```{r}
q2_stan <- 'rmd/homework/Week-05/q2_prior.stan'
writeLines(readLines(q2_stan))

q2_prior <- cmdstan_model(q2_stan)

q2_prior_sample <- q2_prior$sample(data = q2_data[c('N_flights',
																										'N_wine_american',
																										'N_judge_american',
																										'N')])

q2_prior_draws <- cmd_draws(q2_prior_sample)


mcmc_areas(q2_prior_draws, regex_pars = 'flights')
mcmc_areas(q2_prior_draws, regex_pars = 'judge')
mcmc_areas(q2_prior_draws, regex_pars = 'wine')
```



### Model

```{r}
q2_stan <- 'rmd/homework/Week-05/q2.stan'
writeLines(readLines(q2_stan))

q2_model <- cmdstan_model(q2_stan)

q2_sample <- q2_model$sample(data = q2data)
q2_draws <- cmd_draws(q2_sample)
setDT(q2_draws)
```

What do you conclude about the differences
among the wines and judges? Try to relate the results to the inferences in
Problem 1
